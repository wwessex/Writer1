<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>NovelWriter</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="assets/icon-192.png" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400,0,0" />
  <link rel="stylesheet" href="styles.css?v=15" />
</head>
<body>
  <header class="appHeader">
  <div class="topbar">
    <div class="brand">
      <button class="iconBtn iconBtn--square" id="btnToggleSidebar" title="Toggle Chapters" aria-label="Toggle chapters">☰</button>
      <img src="assets/icon-192.png" alt="" class="brand__icon" />
      <div class="brand__text">
        <input id="docTitleTop" class="docTitleInput" value="Untitled Novel" aria-label="Document title" />
        <div class="brand__sub" id="saveStatus">Ready</div>
      </div>
    </div>

    <div class="statusPills" aria-label="Status">
      <div class="pill" id="connPill" title="Connection status">
        <span class="dot" aria-hidden="true"></span>
        <span id="connText">Online</span>
      </div>
      <div class="pill" title="Words in current chapter">
        <span class="pillLabel">Chapter</span>
        <span class="pillValue" id="chapterWords">0</span>
      </div>
      <div class="pill" title="Words in novel">
        <span class="pillLabel">Total</span>
        <span class="pillValue" id="totalWords">0</span>
      </div>
    </div>

    <div class="topbar__actions">
      <button class="iconBtn iconBtn--square" id="btnTheme" title="Toggle theme" aria-label="Toggle theme"><span class="material-symbols-rounded" aria-hidden="true">dark_mode</span></button>
      <button class="btn btn--ghost" id="btnExport" title="Export"><span class="material-symbols-rounded" aria-hidden="true">download</span><span class="btnLabel">Export</span></button>
      <button class="btn btn--ghost" id="btnSettings" title="Settings"><span class="material-symbols-rounded" aria-hidden="true">settings</span><span class="btnLabel">Settings</span></button>
    </div>
  </div>

  <nav class="menubar" aria-label="Menu">
    <button class="menuBtn" data-menu="file">File</button>
    <button class="menuBtn" data-menu="edit">Edit</button>
    <button class="menuBtn" data-menu="view">View</button>
    <button class="menuBtn" data-menu="insert">Insert</button>
    <button class="menuBtn" data-menu="format">Format</button>
    <button class="menuBtn" data-menu="tools">Tools</button>
    <button class="menuBtn" data-menu="help">Help</button>

    <div class="menu" id="menu-file" role="menu">
      <button class="menuItem" data-action="export">Export…</button>
      <button class="menuItem" data-action="backup-export">Export Backup</button>
      <button class="menuItem" data-action="backup-import">Import Backup…</button>
      <div class="menuSep"></div>
      <button class="menuItem" data-action="settings">Settings…</button>
    </div>

    <div class="menu" id="menu-edit" role="menu">
      <button class="menuItem" data-action="undo">Undo</button>
      <button class="menuItem" data-action="redo">Redo</button>
      <div class="menuSep"></div>
      <button class="menuItem" data-action="select-all">Select All</button>
    </div>

    <div class="menu" id="menu-view" role="menu">
      <button class="menuItem" data-action="toggle-sidebar">Toggle Chapters</button>
      <button class="menuItem" data-action="toggle-page">Toggle Page View</button>
    </div>

    <div class="menu" id="menu-insert" role="menu">
      <button class="menuItem" data-action="hr">Horizontal Line</button>
      <button class="menuItem" data-action="blockquote">Blockquote</button>
    </div>

    <div class="menu" id="menu-format" role="menu">
      <button class="menuItem" data-action="bold">Bold</button>
      <button class="menuItem" data-action="italic">Italic</button>
      <button class="menuItem" data-action="underline">Underline</button>
      <div class="menuSep"></div>
      <button class="menuItem" data-action="h1">Heading 1</button>
      <button class="menuItem" data-action="h2">Heading 2</button>
      <button class="menuItem" data-action="p">Paragraph</button>
    </div>

    <div class="menu" id="menu-tools" role="menu">
      <button class="menuItem" data-action="word-count">Word count</button>
      <button class="menuItem" data-action="toggle-page">Toggle Page View</button>
    </div>

    <div class="menu" id="menu-help" role="menu">
      <button class="menuItem" data-action="about">About</button>
    </div>
  </nav>

  <div class="ribbon" id="toolbar" aria-label="Toolbar">
    <div class="ribbonGroup">
      <label class="ribbonLabel">Style</label>
      <select class="select" id="styleSelect" aria-label="Style">
        <option value="p">Normal</option>
        <option value="h1">Heading 1</option>
        <option value="h2">Heading 2</option>
        <option value="quote">Quote</option>
      </select>
    </div>

    <div class="ribbonGroup">
      <label class="ribbonLabel">Font</label>
      <div class="ribbonRow">
        <button class="tb" data-cmd="bold" title="Bold"><b>B</b></button>
        <button class="tb" data-cmd="italic" title="Italic"><i>I</i></button>
        <button class="tb" data-cmd="underline" title="Underline"><u>U</u></button>
        <button class="tb" data-cmd="strike" title="Strike"><s>S</s></button>
      </div>
    </div>

    <div class="ribbonGroup">
      <label class="ribbonLabel">Paragraph</label>
      <div class="ribbonRow">
        <button class="tb" data-cmd="ul" title="Bullet list">• List</button>
        <button class="tb" data-cmd="ol" title="Ordered list">1. List</button>
        <button class="tb" data-cmd="quote" title="Blockquote">❝ ❞</button>
        <button class="tb" data-cmd="hr" title="Horizontal line">―</button>
      </div>
    </div>

    <div class="ribbonGroup">
      <label class="ribbonLabel">History</label>
      <div class="ribbonRow">
        <button class="tb" data-cmd="undo" title="Undo">↶</button>
        <button class="tb" data-cmd="redo" title="Redo">↷</button>
      </div>
    </div>
  </div>
</header>

  <main class="layout">
    <aside class="sidebar" aria-label="Chapters">
      <div class="sidebar__header">
        <div class="sidebar__title">Chapters</div>
        <button class="btn btn--primary btn--small" id="btnNewChapter">+ New</button>
      </div>

      <div class="sidebar__meta">
        <input id="novelTitle" class="input" placeholder="Novel title…" autocomplete="off" />
      </div>

      <ul class="chapters" id="chaptersList" aria-label="Chapter list"></ul>

      <div class="sidebar__footer">
        <button class="btn btn--ghost btn--small" id="btnBackup">Export Backup</button>
        <label class="btn btn--ghost btn--small fileLabel">
          Import Backup
          <input id="importFile" type="file" accept="application/json" />
        </label>
      </div>
    </aside>

    <section class="editorPane">
      <div class="chapterBar">
        <div class="chapterBar__left">
          <input id="chapterTitle" class="input input--title" placeholder="Chapter title…" autocomplete="off" />
        </div>
        <div class="chapterBar__right">
          <button class="btn btn--ghost btn--small" id="btnDeleteChapter">Delete</button>
        </div>
      </div>

      <div class="editorWrap">
        <div id="editor" class="editor" aria-label="Editor"></div>
      </div>
    </section>
  </main>

  <!-- Export modal -->
  <dialog class="modal" id="exportModal">
    <form method="dialog" class="modal__card">
      <div class="modal__header">
        <div class="modal__title">Export</div>
        <button class="iconBtn" value="cancel" aria-label="Close">✕</button>
      </div>

      <div class="modal__body">
        <p class="muted">Exports the whole novel (all chapters) in current order.</p>
        <div class="grid">
          <button class="btn btn--primary" id="exportDocx" type="button">Export DOCX</button>
          <button class="btn btn--primary" id="exportPdf" type="button">Export PDF</button>
          <button class="btn btn--primary" id="exportRtf" type="button">Export RTF</button>
        </div>
        <div class="row">
          <label class="check">
            <input type="checkbox" id="exportIncludeChapterHeadings" checked />
            Include chapter headings
          </label>
        </div>
      </div>

      <div class="modal__footer">
        <button class="btn btn--ghost" value="cancel">Close</button>
      </div>
    </form>
  </dialog>

  <!-- Settings modal -->
  <dialog class="modal" id="settingsModal">
    <form method="dialog" class="modal__card">
      <div class="modal__header">
        <div class="modal__title">Settings</div>
        <button class="iconBtn" value="cancel" aria-label="Close">✕</button>
      </div>

      <div class="modal__body">
        <h3 class="h3">Online Sync (optional)</h3>
        <p class="muted">If configured, the app can sync your novel to a server when online.</p>

        <label class="field">
          <span>Novel ID</span>
          <input class="input" id="syncNovelId" placeholder="e.g. my-novel-001" autocomplete="off" />
        </label>

        <label class="field">
          <span>Sync URL</span>
          <input class="input" id="syncUrl" placeholder="https://your-api.example.com" autocomplete="off" />
        </label>

        <label class="field">
          <span>Auth Header (optional)</span>
          <input class="input" id="syncAuth" placeholder="Bearer …" autocomplete="off" />
        </label>

        <div class="row">
          <button class="btn btn--primary" id="btnSyncNow" type="button">Sync Now</button>
          <span class="muted" id="syncStatus"></span>
        </div>

        <hr class="hr" />

        <h3 class="h3">App</h3>
        <label class="field">
          <span>Autosave interval (ms)</span>
          <input class="input" id="autosaveMs" type="number" min="250" step="50" />
        </label>

        <div class="row">
          <button class="btn btn--ghost" id="btnResetApp" type="button">Reset local data</button>
        </div>

        <p class="muted small">Tip: if caching gets weird after an update, open once with <code>?nosw=1</code>.</p>
      </div>

      <div class="modal__footer">
        <button class="btn btn--ghost" value="cancel">Close</button>
      </div>
    </form>
  </dialog>

  
  <!-- About modal -->
  <dialog class="modal" id="aboutModal">
    <form method="dialog" class="modal__card">
      <div class="modal__header">
        <div class="modal__title">About NovelWriter</div>
        <button class="iconBtn" value="cancel" aria-label="Close">✕</button>
      </div>
      <div class="modal__body">
        <p><strong>NovelWriter</strong> is an offline-first writing app.</p>
        <ul>
          <li>Chapters are isolated documents (editing one won't change the others).</li>
          <li>Autosaves locally to your browser.</li>
          <li>Exports to DOCX / PDF / RTF.</li>
        </ul>
        <p class="muted small">Tip: if the app ever looks out of date, open once with <code>?nosw=1</code> then reload.</p>
      </div>
      <div class="modal__footer">
        <button class="btn btn--ghost" value="cancel">Close</button>
      </div>
    </form>
  </dialog>


  <!-- Word count modal -->
  <dialog class="modal" id="wordCountModal">
    <form method="dialog" class="modal__card">
      <div class="modal__header">
        <div class="modal__title">Word count</div>
        <button class="iconBtn" value="cancel" aria-label="Close">✕</button>
      </div>
      <div class="modal__body">
        <div class="wcGrid">
          <div class="wcCard">
            <div class="wcLabel">Chapter</div>
            <div class="wcValue" id="wcChapter">0</div>
          </div>
          <div class="wcCard">
            <div class="wcLabel">Total</div>
            <div class="wcValue" id="wcTotal">0</div>
          </div>
        </div>
        <p class="muted small">Counts are approximate (based on your current draft text).</p>
      </div>
      <div class="modal__footer">
        <button class="btn btn--ghost" value="cancel">Close</button>
      </div>
    </form>
  </dialog>


  <script>
  // Bootloader: shows on-page errors if modules fail to load (common on iOS / wrong folder / caching)
  (async () => {
    const statusEl = document.getElementById("saveStatus");
    const show = (title, detail) => {
      statusEl && (statusEl.textContent = "Error");
      const box = document.createElement("div");
      box.style.cssText = [
        "position:fixed","inset:12px","z-index:9999",
        "background:rgba(10,15,32,.96)","border:1px solid rgba(255,255,255,.14)",
        "border-radius:16px","padding:14px","box-shadow:0 20px 50px rgba(0,0,0,.45)",
        "font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial",
        "color:#e5e7eb","overflow:auto"
      ].join(";");
      box.innerHTML = `
        <div style="font-weight:800;font-size:16px;margin-bottom:6px">${title}</div>
        <div style="color:#9ca3af;margin-bottom:10px">This means the JavaScript didn't start, so the editor can't be typed in.</div>
        <pre style="white-space:pre-wrap;background:rgba(0,0,0,.25);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);">${String(detail||"")}</pre>
        <div style="margin-top:10px;color:#9ca3af">
          <div><b>Fix checklist:</b></div>
          <ol>
            <li>Make sure <code>index.html</code> and <code>app.js</code> are in the SAME published folder on GitHub Pages.</li>
            <li>Try opening <code>.../app.js</code> in Safari — it should show JavaScript, not a 404 page.</li>
            <li>After updating files, open once with <code>?nosw=1</code> then reload.</li>
          </ol>
        </div>
        <button id="closeDiag" style="margin-top:12px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#e5e7eb;cursor:pointer">Close</button>
      `;
      document.body.appendChild(box);
      box.querySelector("#closeDiag")?.addEventListener("click", () => box.remove());
    };

    try {
      statusEl && (statusEl.textContent = "Loading…");

      // Ensure latest CSS is loaded (prevents iOS caching oddities)
      const cssLink = document.querySelector('link[rel="stylesheet"][href^="styles.css"]');
      if (cssLink && !cssLink.href.includes("v=")) {
        cssLink.href = "./styles.css?v=9";
      }

      const params = new URLSearchParams(location.search);

      // Allow SW reset even if app.js fails
      if (params.get("nosw") === "1" && "serviceWorker" in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }

      // Verify app.js reachable (helps catch wrong folder / 404)
      const r = await fetch("./app.js", { cache: "no-store" });
      if (!r.ok) throw new Error("Fetch ./app.js failed: HTTP " + r.status);
      const txt = await r.text();
      if (!txt || txt.length < 200) throw new Error("app.js looks too small; got " + (txt ? txt.length : 0) + " chars.");

      // Start app with cache-bust to avoid stale SW/module cache
      await import("./app.js?v=" + Date.now());
      statusEl && (statusEl.textContent = "Ready");
    } catch (err) {
      show("NovelWriter failed to start", err && (err.stack || err.message || String(err)));
    }
  })();
  </script>

</body>
</html>
